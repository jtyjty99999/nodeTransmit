##node MapServer

公司想做一张私有地图，不带渲染。。主要提供一些计算功能

我就按照转发器的方式做了。。用到了很多包，也算练手了。


##我的构思

利用connect+router来处理请求并分发. lib里面有很多用来计算的工具帮忙计算一些需要的数据

同时启动时把地图数据从mysql读取出,初始化到redis.

之后利用计算模块计算数据并返回，或做一些其他的处理，比如与公司其他系统api进行通信,返回图片等

另外带有通用的错误处理与日志模块.对外暴露api.


##实现技术

利用connect包实现http相关的请求与中间件,urlrouter实现路由,request包实现向外发请求

cluster模块来实现多核

graceful实现"优雅退出"

mysql与redis包做处理

##todo

地图数据如何构建并初始化到redis中,之前采用的是100*经纬度的小数点两位，我感觉应该要按照poi密度来划分.因此首先要对poi数据进行一轮初筛

纠偏算法

扇形区域算法

道路最短路径加权算法

多系统联调

性能与容灾测试

##progress

计算两点的距离，夹角与中点

使用了googlemap的算法,传入一对经纬度坐标，可以计算坐标的距离与夹角，可以很方便的判定某坐标是否在某个视角内。

http://192.168.1.55:3000/getDistance?lat1=39.93674452&lon1=116.38627001&lat2=39.93707524&lon2=116.3921065


根据距离与方向角计算下一点的位置

使用了googlemap的算法,传入一个经纬度坐标，距离与夹角，可以计算另一个点的位置。距离可以转为速度与时间，因此此算法可以动态预测位置。

http://192.168.1.55:3000/getNextPoint?lat=39.93260527&lon=116.35562122&angle=88&distance=1.354

计算点是否在区域内部

未来我们的路表我认为可以利用geojson或者topojson格式进行存储。可以轻松存储大量信息，也有利于nosql技术的使用。
一个路表的示例可以参考附件。
这个算法可以让我们计算出 车是否在某条路上。我们可以给路增加一些自定义属性来更加方便查找。

http://192.168.1.55:3000/pInP?area=[{x:37.628134,y:-77.458334},{x:37.629867,y:-77.449021},{x:37.62324,y:-77.445416},{x:37.622424,y:-77.457819}]&lat=37.62850&lon=-77.4499


历史轨迹查询

原始数据为晓天的28w条路况数据,持久化在mongodb上.没有做任何存储优化。
时间戳为1378449984到1381566402
http://192.168.1.55:3000/history?gt=1378449984&lt=1378450020
此接口主要为我们后续的poi跟轨迹存储使用nosql技术做准备

测试读写缓存

未来我们大部分的数据都会持久化到缓存中。因此我开了两个接口来测试读写缓存
http://192.168.1.55:3000/testReadInCache?set=helloworld&key=google
http://192.168.1.55:3000/testWriteInCache?set=helloworld&key=google&value=123


测试写本地文件

很多时候我们需要进行远程图片，文件的读写保存，此模块可以实现读取远程url然后保存到本地。使用了stream(流)技术可以大大降低内存消耗

http://192.168.1.55:3000/testWriteMap?url=http://www.google.cm/images/srpr/logo4w.png&toFile=doodle.png

测试读本地文件

为未来的展现层做准备，使用了图片压缩及stream(流)技术。

http://192.168.1.55:3000/testReadMap?file=doodle.png

测试外部api

服务器可以向第三方进行请求，返回所需要的数据。并且由于很多古旧的接口有编码问题，也引入了编码库与xml解析库来处理。
http://192.168.1.55:3000/addressToPoints?address=上海市长宁区北渔路
(此接口为高德的 地理信息匹配(geoSearch)接口)

坐标加密(未测试)

使用了所谓业内的加密算法,传入一个经纬度坐标，可以返回处理过的坐标

http://192.168.1.55:3000/getDistance?lat1=39.93674452&lon1=116.38627001&lat2=39.93707524&lon2=116.3921065

##now 

http://localhost:3000/waze.html

12年4月我加入语镜，这估计是我在语镜的最后一个项目了吧。

还记得刚来公司，就那么几个人，我们其乐融融，大半夜里谈论各种互联网时事

还记得我们畅想着未来的ipo，畅想着明天。。

但是，我们毁在了硬件上。

13年5月，姗姗来迟的第二轮融资，赶鸭子上架般的大规模招人

内部不断出现的裂痕。。

我该走了。  2013.10.22  1：00

我完成了刚来公司时的一个愿望，成功做出中国的waze

但，这仅仅是一个demo，就像我们无数弃之不用的demo一样。。
